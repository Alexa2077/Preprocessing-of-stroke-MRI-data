主要介绍概念

# 1，什么是配准？
## 1.1 什么是配准？
**Image registration 图像配准**，是图像处理研究领域中的一个典型问题和技术难点，其目的在于比较或融合针对同一对象在不同条件下获取的图像，例如**图像会来自不同的采集设备**，**取自不同的时间**，**不同的拍摄视角**等等，有时也需要用到针对不同对象的图像配准问题。  
具体地说，对于一组图像数据集中的两幅图像，通过寻找一种空间变换把一幅图像（浮动图像，moving image）映射到另一幅图像（参考图像，fixed image）上，使得两图中对应于空间同一位置的点一一对应起来，从而达到信息融合的目的。

**医学图像配准：**  
在这两张图片上，很容易看出它们没有对齐，左边相对右边倾斜，虽然我们人类视觉系统还是能把对应的解剖关系连系在一起，但是我们使用计算机分析时确不能够。  
![image](https://github.com/Alexa2077/Preprocessing-of-stroke-MRI-data/assets/59952693/557bd561-76f8-442d-a2d2-8b43d6e6d32a)

因此，我们希望相同的解剖结构对齐，用坐标表示的话，希望他们在相同的坐标上。如下图
![image](https://github.com/Alexa2077/Preprocessing-of-stroke-MRI-data/assets/59952693/832d48ed-47af-4612-9c53-2443c6390773)

对齐这些解剖结构的过程就叫做配准（register）  
因此，配准的目的也是使相同的解剖结构在同一个位置，便于分析。可以将CT和MRI配准，看同一结构在两个模态上的变化，更易于疾病的诊断。同理PET-MRI等也可以进行配准。不同的MRI序列之间也可以配准。同一个MRI序列，前后做的两次图像也可以配准，等等。  
配准的概念：  
[https://community.mrtrix.org/t/registration-transformation-regridding-concepts/3684](https://community.mrtrix.org/t/registration-transformation-regridding-concepts/3684)

注：其实配准就是解决不同数据的尺度等的大小不一，为了定量分析而做的标准化操作。  
注：如果是配准脑部，最好先去头骨等组织。因为我们只希望配准脑组织，并不关心鼻子，眼睛是否配准，而他们会干扰配准的速度和准确性。如下图所示为未颅骨剥离的例子：  
![image](https://github.com/Alexa2077/Preprocessing-of-stroke-MRI-data/assets/59952693/d2f2e2dd-e99a-4c43-9580-58d3aed8d323)
  
## 1.2 配准的分类  
根据准则不同，配准方法可以有以下分类方式：  
![image](https://github.com/Alexa2077/Preprocessing-of-stroke-MRI-data/assets/59952693/e0d37909-775b-45f4-964c-aca6901f2d4b)
  
### 1.2.1 根据空间维数  
若仅考虑空间维数，可以划分为2D/2D, 2D/3D, 3D/3D。若考虑时间序列因素，还存在对在不同时刻提取的两幅图像进行配准的问题。  
### 1.2.2 根据算法所基于的特征及相似性测度
**基于内部特征**  
内部特征指的是从图像内部本身提取的信息：  
基于特征点：在几何上有特别意义的可以定位的特征点集（比如不连续点，图形的转折点，线交叉点等），在医学图像上更可以是具有解剖意义的点。  
基于表面：用[分割](https://zh.wikipedia.org/wiki/%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2)的方法提取出感兴趣的部分的轮廓（曲线或曲面），以作为用来比较的特征空间[[4][[5]] 
 (https://zh.wikipedia.org/wiki/%E5%9B%BE%E5%83%8F%E9%85%8D%E5%87%86#cite_note-Davatzikos2-5)](https://zh.wikipedia.org/wiki/%E5%9B%BE%E5%83%8F%E9%85%8D%E5%87%86#cite_note-Davatzikos-4)。
基于像素值：利用整幅图像的像素或体素（Intensity-Based）来构成特征空间。根据像素值的统计信息来计算相似性测度又可划分为[最小二乘法] 
 (https://zh.wikipedia.org/wiki/%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E6%B3%95)，傅里叶法，互相关法，互信息法等等。
**基于外部特征**  
在医学图像中，通过在患者身上固定标记物或向体内注入显影物质以获得在图像上的确定的标记点，称为外部特征点。  


### 1.2.3 根据变换性质  
对图像进行空间变换可以分为**刚体变换**（rigid）和**非刚体变换**（non-rigid,deformable）。通常有**刚体变换，仿射变换，投影变换和曲线变换。**  
   (1) **刚体变换**: 所谓刚体 ,是指物体内部任意两点间的距离保持不变。例如 ,可将人脑看作是一个刚体。处理人脑图像 ,对不同方向成像的图像配准常使用刚体变换 [4] 。 刚体变换可以分解为**旋转和平移**
   (2) **仿射变换:** 仿射变换 [5] 将直线映射为直线 ,并保持平行性。具体表现可以是各个方向尺度变换系数一致的均匀尺度变换或变换系数不一致的非均匀尺度变换及剪切变换等。 均匀尺度变换多用于使用透镜系统的照相图像 ,在这种情况下 ,物体的图像和该物体与成像的光学仪器间的距离有直接的关系 ,一般的仿射变换可用于校正由 CT 台架倾斜引起的剪切或 MR梯度线圈不完善产生的畸变。
   (3) **投影变换**: 与仿射变换相似 ,投影变换 [6] 将直线映射为直线 ,但不再保持平行性质。投影变换主要用于二维投影图像与三维体积图像的配准。
   (4) **非线性变换**: 非线性变换 [7] 也称做弯曲变换 (curved transformation) ,它把直线变换为曲线。 使用较多的是多项式函数 ,如二次、三次函数及薄板样条函数。 有时也使用指数函数。 非线性变换多用于使解剖图谱变形来拟合图像数据或对有全局性形变的胸、腹部脏器图像的配准。    
![image](https://github.com/Alexa2077/Preprocessing-of-stroke-MRI-data/assets/59952693/edfdc9e8-b89a-4b05-b9bf-0f479db6f29a)


### 1.2.4 根据优化算法
当比较特征采用特征点集的形式时，可以通过联立方程组来找到变换的解。但一般情况下，配准问题都会转化为求解相似性测度最优值的问题，在计算方法中通常需要采用合适的迭代优化算法，诸如梯度下降法、牛顿法、Powell法、遗传算法等。
## 1.3 医学图像配准
### 1.3.1 根据图像模态
由于医学成像设备可以提供关于患者不同信息不同形式的图像（计算机断层扫描CT，核磁共振MRI，正电子发射断层成像PET，功能核磁共振fMRI等），所以根据模态又可以划分为**单模态**和**多模态（Multi-modal）。**  
  (1)单模 ( monomodality )医学图像配准: 是指**待配准的两幅图像是用同一种成像设备**获取的。  
  (2)多模 ( multimodality)医学图像配准:是指待**配准的两幅图像来源于不同的成像设备**。  

### 1.3.2 根据主体    
可分为**Intrasubject（图像来自于同一病人**）**，Intersubject（来自不同的病人**）和**Atlas（病人数据和图谱的配准）三种。**  

**（1）自身图像配准**(intra-subject)**：**
待配准的图像可以是同一个人的 ,属于患者自身图像配准 (intra-subject)。对同一病人在不同时间获取同一器官或解剖部位的图像 ,可以用于对比 ,从而监视疾病的发展及治疗过程。如果没有局部的组织切除 ,这种配准一般用刚体变换就可以了。

**（2）人间图像配准 (inter-subject)**  
除此之外 ,有时要将被试者的图像与典型正常人相同部位的图像对比 ,以确定被试者是否正常;如果异常 ,也许还要与一些疾病的典型图像对比 ,确定患者是否属于同类。 这些都属于不同人间的图像配准 (inter-subject) [10] 。由于个体解剖的差异 ,后者的配准显然要难于前者。  

**（3）图像与图谱配准 ( Atlas Method)或与物理空间配准**  
由于不同人在生理上存在差异 ,同一解剖结构的形状、大小、位置都会很不相同 ,这就使不同人的图像配准问题成为当今医学图像分析中的最大难题。 在对比和分析不同的医学图像时 ,很难精确找出对应的解剖信息。这要求有一个详细标记人体各个解剖位置的计算机化的**标准图谱**。  
 常见的方法大致有两类:** 一是借助一个共同的标准来比较** ,例如要对两个病人的 PET 或 MR图像 [11] 进行比较 ,首先要把二者的图像都映射到一个共同的参考空间去 ,然后在此空间中对二者进行比较 ,使用较多的是** Talairach标准空间** ,可以对不同的人脑图像进行比较；**二是非线性形变法 **,模仿弹性力学方法 ,将一个人的 3D图像逐步变换 ,使它最终能较好地与另一个人的3D图像最佳匹配。
